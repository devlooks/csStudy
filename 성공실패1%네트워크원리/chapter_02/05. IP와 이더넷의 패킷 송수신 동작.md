### 1. 패킷의 기본

- 패킷의 구성 : 헤더, 데이터  
  헤더 : 제어정보  
  데이터 헤더 뒤에 붙는 의뢰처에서 의뢰한 데이터  
  
  - 이더넷 패킷 : MAC 헤더(이더넷제어정보) + IP 헤어 + TCP 헤더 + 데이터 조각  

  - IP 패킷 : IP헤더(IP제어정보) + TCP 헤더(TCP제어정) + 데이터 조각  

- 패킷의 이동  
  1. 패킷의 송신처가 되는 기기가 패킷을 만듬
  2. 적절한 제어정보 기록
  3. 헤더의 제어정보 기반으로 가까운 중계 장치로 송신

- 엔드 노드 : 패킷이 도착 하거나 출발하는 곳을 의미한다.

- 패킷의 중계 수단  
  1. 허브 : 이더넷 규칙에 따라 운반(MAC 헤더)
  2. 라우터 : IP 규칙에 따라 운반 (IP 헤더)

- 패킷 일련의 이동 동작 
  1. 이더넷 원리 사용 - 허브 도착(이더넷 표 사용) - 가까이 있는 허브가 2개면 둘다 경유, 1개면 그쪽으로 이동
  2. IP 원리 사용 - 라우터 도착 (IP 표 사용) - 다음 라우터에 패킷 건내기 위해 MAC 주소 조사, MAC 헤더에 기록

- 허브와 라우터 역할 분담하는 이유  
  이더넷는 무선 LAN, ADSL, FTTH등, IP의뢰 받아, 패킷 운반 할 수 있으면 전부 운반 할 수 있으며,
  거대 네트워크 구축시 이런 유연성이 꼭 필요히 때문  
    
 ### 2. 패킷 송수신 동작의 개요
 
- 패킷 운반의 과정
  
  1. TCP 부분이 TCP 헤더가 부가된 것을 IP담당 부분에게 건내줌
  2. IP 담당 부분은 IP 헤더와, MAC헤더를 부가
  3. 패킷을 네트워크용 하드웨어에 건네줌
  4. 네트워크 하드웨어(LAN 어댑터)에서 데이터를 전기 또는 빛신호로 전환, 케이블 송출
  5. 상대에게 패킷이 도착, 그리고 회답이 돌아옴
  6. 돌아올떄는, 전기 또는 빛 신호를 네트워크 하드웨어가 디지털 데이터로 전환
  7. IP담당 부분에게 건네줌
  8. IP담당은 TCP담당에게 건네줌

- IP담당 부분은 TCP헤더와 데이터 조각을 한 덩어리의 바이너리 데이터로 간주, 내용 보지 않고 송수신 동작함.

### 3. 수신처 IP주소를 기록한 IP 헤더를 만든다.

1. IP담당 부분은 IP헤더를 만들어 TCP 헤더 앞에 부가한다.
2. IP헤더에는 수신처 IP주소가 들어가 있으며, 이 수신처 주소의 출처는 Socket이다 -> 책임이 어플리케이션에 있음(수신 신패 등..)
3. IP헤더에는 송신처 IP주소도 들어가 있다(해당 기기의 LAN 어댑터의 할당된 IP 주소)

- IP 경로표  
- CMD 명령어 ROUTE PRINT 에서 경로 표가 출력된다.

- 경로표 설명(route print)  
  1. Network Destination, Netmask -> 수신처 주소(최종 목적지 의미)
  2. Interface -> 수신처로 송신시 해당 기기에서 사용하는 네트워크 어댑터의 ip
  3. Gateway -> 다음 라우터 주소
  4. Metric -> 경로 운반시 비용


### 4. 이더넷용 MAC 헤더를 만든다

- MAC 헤더의 구성
  1. 이더타입 : IP프로토콜번호에 따른 값 설정
  2. 송신처 MAC 주소 : 송신 담당 LAN 어댑터의 MAC주소를 설정
  3. 수신처 MAC 주소 : 경로표의 Gateway 항목 IP 주소

### 5. ARP로 수신처 라우터의 MAC 주소를 조사한다.

- ARP : IP주소를 이용, 전달할 라우터의 MAC주소를 알아내는 프로토콜
- ARP 캐시 : 패킷 송신전에 ARP 캐시를 조사, 데이터 있다면, 해당 캐시 값을 사용한다.  
             캐시의 값은 일정 시간이 지나면 삭제 됨(ARP 캐시에 저장된 MAC주소는 항상 같을순 없기 때문)  
             
### 6. 이더넷의 기본
  - 생략
 
### 7. IP 패킷을 전기나 빛의 신호로 변환하여 송신한다

- LAN 어댑터 + LAN 드라이버 소프트웨어를 사용하여, 디지털 데이터를 빛 또는 전기 신호를 전환하여, 케이블에 송출한다.

- LAN 어댑터는 즉시 사용은 안되며, 초기화 작업이 필요하다. MAC 회로에 MAC 주소를 설정 하는 과정이 필요하다.

- LAN 어댑터의 ROM에는 MAC 주소 설정하기 위한 전세계적으로 일원한된 정보가 있음.

### 8. 패킷에는 3개의 제어용 데이터를 추가한다.

- LAN 드라이버가 IP부분으로부터 정보를 받으면, 이를 버퍼 메모리에 복사한다.  
  복사 후, 송신 작업시작한다.

- 패킷 구성(LAN 어댑터)  
  프리앰블 + 스타트 프레임 딜리미터 + MAC 헤더 + IP헤더 + TCP 헤더 + 데이터 + FCS  
  
  - 프리앰블과 스타트 프레임 딜리미터를 MAC헤더 앞에 부과, 끝에는 FCS (프레임 체크 시퀀스)라는 오류 검출용 데이터를 부가한다.

  - 프리앰블 : 클록의 시호의 타이밍을 잡기위한 특별한 신호 (신호를 언제 부터 읽으면 되는지 판단하는것)

  - 스타트 프레임 딜리미터 : 패킷의 시작을 나타내는 표시

  - FCS : 패킷 운반중 파형 즉, 신호가 흐트러져 데이터가 변한 경우 이것을 검출하기 위해 사용

### 9. 허브를 향해 패킷을 송신한다. (MAC회로 -> PHY(MAU)회로)

- 신호 송신 모드 
  1. 반이중 모드 -> 리피터 허브 사용
  2. 전이중 모드 -> 스위치 허브 사용

- 반이중 모드 : 송신한 신호가 흐르는지 조사, 끝날때까지 기다렸다 송신 동작(중도에 송신시 충돌 발생)
    
- 반이중 모드 송신 동작
  1. MAC 회로가 프리앰블의 맨앞부터 1비트씩 차례로 디지털 데이터를 전기신호로 변환
  2. PHY(MAU)라는 송수신 부분에 전달
  3. PHY(MAU)는 케이블에 송출하는 형식으로 변환하여 송신

- PHY(MAU)회로는, 송신 동작 뿐만 아니라, 신호가 들어오는지 감시, 
  송신 완료할 때까지 수신 신호선에 신호가 들어오지 않으면 송 수신 동작이 끝남
  
- 이더넷은 상대방에게 완전히 도착했는지 확인 안함

- 이더넷 사용은 100m 이내로 정함, 그래서 좀처럼 잡음이 없어, 오류발생 안함.

- 송신시, 수신 신호가 들어오면, 충돌 발생, 이 때 재밍신호를 잠시 동안 흘림,
  송신 멈춤, 잠시 대기후, 송신 동작 시도  

- 충돌 재발생할떄는, 대기 시간을 2배로 늘려서 다시 송신 동작 


### 10. 돌아온 패킷을 받는다. (PHY(MAU)회로 -> MAC 회로)

1. PHY(MAU)회로에서 MAC회로로 받는다. 
2. 케이블 신호 -> 전자 신호 -> 디지털 데이터 번환(MAC회로)
3. 버퍼 메모리 저장
4. FCS값과 FCS 계산값 비교 x -> 폐기
5. MAC 헤더 검사 수신처 X -> 폐기
6. 버퍼메모리 저장
7. 인터럽트로 패킷 수신 알림
8. 인터럽트 번호에 따라 LAN 드라이버 동작
9. LAN 드라이버 프로토콜 판별(MAC 헤더)
10. 프로토콜 스택 IP부분에 데이터 건내줌


### 11. 서버의 응답 패킷을 IP에서 TCP로 넘긴다.

1. 프로토콜 스택 IP부분에 데이터를 건데 받음
2. IP부분 IP헤더 조사
3. 틀리면 ICMP로 오류 통지
4. 맞으면 수신
5. IP헤더의 플레그로 패킷이 조각나누기 되어있는지 확인
6. 조각 나누기 되어있다면, IP헤더의 ID 정보, 프레그먼트오프셋 참조 -> 리어셈블링한다
7. TCP담당 부분에 다시 건네줌
8. TCP담당 부분은 IP헤더에 기록된, 수신처IP, 송신처IP, TCP헤러의 수신처 포트, 송신처포트 조사하고, 맞는 소켓을 찾아 건네준다

