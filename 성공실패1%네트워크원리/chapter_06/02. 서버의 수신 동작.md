### 1. LAN 어댑터에서 수신 신호를 디지털 데이터로 변환한다.

- LAN 어댑터는 MAC 부분이 패킷을 신호로부터 디지털 데이터로 변환, FCS를 점검후 메모리에 저장한다.

  - 서버에 도착하는 패킷의 실체는 전기 또는 빛의 신호

  - 수신 동작은 LAN 어댑터에서 수신 

  - LAN을 흐르는 신호는 1과 0으로 이루어진 디지털 데이터의 신호와 타이밍을 나타내는 클록 신호를 합성한것  
    클록 신호와 타이밍을 계산, 신호를 읽어 1과 0의 디지털 신호로 전환

  - 해당 데이터를 변환하는 과정에서 오류검사식에 따라 계산하고 그 값을 패킷의 맨 끝값을 FCS필드의 값과 비교함.

  - FCS와 같으면 수신, 다르면 버림 -> (TCP가 검사, 누락된 패킷을 다시 보냄, 버려도 상관없음)

  - MAC헤더, 수신처 MAC주소 조사, 패킷을 수신 받는것이 맞는지 판단. (맞지 않는 패킷은 폐기)

- LAN 드라이버가 MAC 헤더로 부터 프로토콜을 판단하여 프로토콜 스택에 패킷을 건네준다.
  
  - 인터럽트 방식으로 LAN어댑터는 CPU에 패킷의 도착을 알림
  
  - CPU는 LAN어댑터의 버퍼메모리에서 데이터 추출
  
  - MAC헤더 타입필드의 값에 따라 프로토콜 판별, 처리 소프트웨어(IP 프로토콜, TCP 프로토콜 등..) 호출
  
  - 데이터 해당 소프트웨어에 건내줌

### 2. IP 담당 부분의 수신 동작

- 프로토콜 스택에 패킷이 전달 되면 IP담당 부분이 동작 IP헤더 점검

- IP 헤더의 내용이 정상인지 점검 -> 해당 기기 대상인지 조사

- 대상 확인 후, 패킷이 분할되어있는지 확인(조각나누기)

- 분할 되어있는 경우 패킷을 메모리에 일시 저장

- 패킷 전부 도착 시점에 패킷 조립, 복원한다.

- 담당 부분에 패킷 전송

- 프로토콜 번호 항목 확인후 해당 부분에 패킷을 넘겨준다.
  1. 06 : TCP 
  2. 11 : UDP

### 3. TCP 담당 부분이 접속 패킷을 수신 했을때의 동작

- TCP 헤더에 SYN 패킷 1일때 접속 동작의 패킷

- SYN일떄 접소 동작을 실행 수신처포트 조사, 같은 번호의 접속 대기 상태의 소켓있는지 확인

- 없으면 오류 통지 패킷을 클라이언트에 반송

- 접속 대기 소켓이 있을 경우 

  1. 접속 대기 소켓이 존재시, 패킷 복사, 새소켓을 만듬
  2. 새소켓에 송신처의 IP주소, 포트 번호, 시퀀스 번호의 초기값, 윈도우의 값 등 필요 정보 기록
  3. 동시에 송신 버퍼, 수신 버퍼로 사용하는 메모리 영역 확보
  4. 패킷을 받았음을 나타내는 ACK 번호, 서버에서 클라이언트로 보내는 데이터에 관한 시퀀스 번호의 초깃값  
    클라이언트에서 서버로 보내온 데이터를 받기 위한 수신 버퍼의 빈 용량을 나타내는 윈도우 값을 항목을 기록한 TCP헤더 만들고
    이것을 IP 담당 부분에 의뢰 클라이언트에 반송한다.
  5. 클라이언트에서 패킷을 받았음을 나타내는 ACK 번호 돌아오면 접속 동작 완료.
  6. 이때 서버측의 애플리케이션은 accept를 호출 실행을 쉬는 상태
  7. 새로 만든 소켓의 디스크립터를 전달, 서버 어플리케이션의 동작을 재개한다.

### 4. TCP 담당 부분이 데이터 패킷을 수신헀을 때의 동작

- 도착한 패킷이 어느 소켓에 해당하는지 조사

- 중복 포트의 소켓이 존재 할수 있음 그러므로  
  송신처 IP, 수신처 IP, TCP 헤더의 수신처 포트 번호와  
  송신처 포트 번호라는 4개의 정보가 모두 합치되는 소켓을 찾습니다.

- 패킷에 기록되어있는 데이터 송수신의 진행 상황과 도착한 패킷의 TCP 헤더의 정보 결합  
  수신 동작이 올바르게 진행 되는지 점검
  
- 소켓에 기록된 지난 번 시퀀스 번호, 
  지난 번 데이터 조각의 길이로부터 다음 시퀀스 번호의 값을 계산
  도착한 패킷의 TCP 헤더에 기록된 시퀀스 번호와 합치되는지 조사한다.
  
- 둘이 합치시, 패킷이 정상 상태로 도착

- 수신 버퍼에 저장 

- 이전에 전송된 패킷과 연결되어 데이터 분할 전상태로 복원

- 수신 버퍼에 저장시 수신 확인 응답용 TCP 헤더 만들고  
  헤당 헤더에 수신 패킷의 시퀀스 번호와 데이터 조각의 길이로부터 계산한 ACK 번호를 기록
  IP 담당 부분에 의뢰 클라이언트를 반홍 한다.
  
- Socket 라이브러리의 read 호출 수신한 데이터를 애플리케이션에 건내준다.

### 5. TCP 담당 부분의 연결 끊기 동작

- 데이터 송수신이 끝나면 송수신 연결 끊기 동작 

- 클라이언트, 서버 중 어느 쪽에 먼저 실행해도 상관 없음.

  1. 서버측에서 애플리케이션이 Socket 라이브러리의 close 호출
  2. TCP 담당 부분이 FIN 이라는 컨트롤 비트에 1을 설정한 TCP 헤더를 만든후
  3. IP 담당 부분에 의뢰 클라이언트에 보냄
  4. 클라이언트에 도착 후 클라이언트는 ACK 번호 반송
  5. 클라이언트 쪽에서도 close 호출 
  6. FIN 1인 TCP 헤더를 서버에 보내고, 서버가 ACK 번호를 반송
  7. 연결 끊기 동작 종료
  8. 끊기 동작 종료후 잠시 대기후 소켓 
